    this.ui = {
      hpBar: document.getElementById("hp-bar"),
      hpLabel: document.getElementById("hp-bar-label"),
      mpBar: document.getElementById("mp-bar"),
      mpLabel: document.getElementById("mp-bar-label"),
      statContainer: document.getElementById("stat-lines"),
      timerValue: document.getElementById("sidebar-timer-value"),
      killValue: document.getElementById("sidebar-kill-value"),
      rankValue: document.getElementById("sidebar-rank-value"),
      pointValue: document.getElementById("sidebar-point-value"),
      equipmentDetails: document.getElementById("sidebar-equipment-details"),
      bossHeader: document.getElementById("boss-header"),
      bossName: document.getElementById("boss-name"),
      bossTitle: document.getElementById("boss-title"),
      shopOverlay: document.getElementById("shop-overlay"),
      shopItems: document.getElementById("shop-items"),
      shopMessage: document.getElementById("shop-message"),
      shopGoldValue: document.getElementById("shop-gold"),
      shopRefreshBtn: document.getElementById("shop-refresh-btn"),
      shopCloseBtn: document.getElementById("shop-close-btn"),
      shopExitRunBtn: document.getElementById("shop-exit-run-btn"),
      shopTitle: document.querySelector("#shop-overlay .shop-title"),
      shopGoldLabel: document.querySelector("#shop-overlay .shop-gold"),
      // Spellcard overlay elements
      spellOverlay: document.getElementById("spellcard-overlay"),
      spellIllustration: document.getElementById("spellcard-illustration"),
      spellName: document.getElementById("spellcard-name"),
      // HTML stats overlay
      statsOverlay: document.getElementById("stats-overlay"),
      statsTitle: document.getElementById("stats-title"),
      statsBarDealt: document.getElementById("stats-bar-dealt"),
      statsBarTaken: document.getElementById("stats-bar-taken"),
      statsBarGold: document.getElementById("stats-bar-gold"),
      statsBarHeal: document.getElementById("stats-bar-heal"),
      statsValDealt: document.getElementById("stats-val-dealt"),
      statsValTaken: document.getElementById("stats-val-taken"),
      statsValGold: document.getElementById("stats-val-gold"),
      statsValHeal: document.getElementById("stats-val-heal"),
      statsRestartBtn: document.getElementById("stats-restart"),
      // progress
      statsProgressTrack: document.getElementById("stats-progress-track"),
      statsProgressArrow: document.getElementById("stats-progress-arrow"),
      statsProgressLabel: document.getElementById("stats-progress-label"),
    };

    // 若外部HTML未提供统计覆盖层，则在此处动态构建一套（保障必然可见）
    if (!this.ui.statsOverlay) {
      this.buildStatsOverlayDom?.();
      // 重新绑定引用
      this.ui.statsOverlay   = document.getElementById("stats-overlay");
      this.ui.statsTitle     = document.getElementById("stats-title");
      this.ui.statsBarDealt  = document.getElementById("stats-bar-dealt");
      this.ui.statsBarTaken  = document.getElementById("stats-bar-taken");
      this.ui.statsBarGold   = document.getElementById("stats-bar-gold");
      this.ui.statsBarHeal   = document.getElementById("stats-bar-heal");
      this.ui.statsValDealt  = document.getElementById("stats-val-dealt");
      this.ui.statsValTaken  = document.getElementById("stats-val-taken");
      this.ui.statsValGold   = document.getElementById("stats-val-gold");
      this.ui.statsValHeal   = document.getElementById("stats-val-heal");
      this.ui.statsRestartBtn= document.getElementById("stats-restart");
      this.ui.statsProgressTrack = document.getElementById("stats-progress-track"); this.ui.statsProgressArrow = document.getElementById("stats-progress-arrow"); this.ui.statsProgressLabel = document.getElementById("stats-progress-label");
    }
    const selectFirst = (selectors) => selectors.map((s) => document.querySelector(s)).find(Boolean);
    const skillSelectors = {
      Q: ['.skill-slot[data-skill="Q"]', '[data-skill="Q"]', '#skill-q', '.skill-q'],
      E: ['.skill-slot[data-skill="E"]', '[data-skill="E"]', '#skill-e', '.skill-e'],
      R: ['.skill-slot[data-skill="R"]', '[data-skill="R"]', '#skill-r', '.skill-r'],
      DASH: ['.skill-slot[data-skill="SPACE"]', '[data-skill="SPACE"]', '#skill-space', '.skill-space'],
    };

    const iconMap = { Q: "skill_Q", E: "skill_E", R: "skill_R", DASH: "skill_SPACE" };

    this.ui.skillUi = {};

    Object.entries(skillSelectors).forEach(([key, selectors]) => {
      const slotCandidate = selectFirst(selectors);
      if (!slotCandidate) return;
      const slot = slotCandidate.classList?.contains("skill-slot")
        ? slotCandidate
        : slotCandidate.closest?.(".skill-slot") || slotCandidate;
      if (!slot) return;
