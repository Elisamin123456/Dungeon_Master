  }
  handleMouseWheel(_pointer, _gameObjects, _deltaX, deltaY) {
    if (!deltaY) return;
    const direction = Math.sign(deltaY);
    if (direction === 0) return;
    this.currentZoom = Phaser.Math.Clamp(this.currentZoom - direction * CAMERA_ZOOM_STEP, CAMERA_ZOOM_MIN, CAMERA_ZOOM_MAX);
    this.cameras.main.setZoom(this.currentZoom);
    this.updateOverlayScale();
  }
  updateOverlayScale() {
    const overlayScale = CAMERA_ZOOM / this.currentZoom;
    this.scaleOverlayElement(this.roundOverlayBackground, overlayScale);
    this.scaleOverlayElement(this.roundOverlayElements, overlayScale);
    this.scaleOverlayElement(this.pauseOverlayBackground, overlayScale);
    this.scaleOverlayElement(this.pauseOverlayElements, overlayScale);
    this.scaleOverlayElement(this.gameOverOverlayBackground, overlayScale);
    this.scaleOverlayElement(this.gameOverOverlayElements, overlayScale);
  }
  scaleOverlayElement(target, scale) {
    if (!target) return;
    if (Array.isArray(target)) { target.forEach((t)=> this.scaleOverlayElement(t, scale)); return; }
    if (target instanceof Phaser.GameObjects.Text) setFontSizeByScale(target, scale);
    else if (typeof target.setScale === "function") target.setScale(scale);
  }

  /* ==== 声音与暂停 ==== */
  playSfx(key, overrides = {}) {
    if (!this.sound) return;
    // 触发节流：同一素材最小间隔 0.2s
    const now = this.time?.now ?? performance.now();
    const last = this.sfxLastPlayed?.[key] ?? 0;
    if (now - last < (this.sfxMinIntervalMs ?? 200)) return;
    this.sfxLastPlayed[key] = now;
    const baseConfig = this.sfxConfig?.[key] ?? {};
    this.sound.play(key, { ...baseConfig, ...overrides });
  }
  handlePauseKey(event) {
    if (!event || event.code !== "Escape") return;
    if (event.repeat) { event.preventDefault(); return; }
    if (this.isGameOver || this.roundAwaitingDecision || (this.roundComplete && !this.isPaused)) return;
    event.preventDefault();
    if (this.isPaused) this.resumeGame();
    else this.pauseGame();
  }
  pauseGame() {
    if (this.isPaused || this.roundComplete || this.roundAwaitingDecision) return;
    this.isPaused = true;
    this.physics.pause();
    this.time.timeScale = 0;
    if (this.battleBgm?.isPlaying) this.battleBgm.pause();
    if (this.attackTimer) this.attackTimer.paused = true;
    if (this.spawnTimer) this.spawnTimer.paused = true;
    // Use unified HTML overlay for pause
    this.showHtmlStatsOverlay("pause");
    this.playSfx("pause");
  }
  resumeGame() {
    if (!this.isPaused) return;
    this.isPaused = false;
       this.time.timeScale = 1;
    this.physics.resume();
    if (this.battleBgm) {
      if (this.battleBgm.isPaused) this.battleBgm.resume();
      else if (!this.battleBgm.isPlaying) this.battleBgm.play();
    }
    if (this.attackTimer) this.attackTimer.paused = false;
    if (this.spawnTimer) this.spawnTimer.paused = false;
    this.clearPauseOverlay();
    this.hideHtmlStatsOverlay?.();
  }
  exitToStartFromPause() {
    if (!this.isPaused) return;
    this.clearPauseOverlay();
    this.hideHtmlStatsOverlay?.();
    this.isPaused = false;
    this.time.timeScale = 1;
    this.physics.resume();
    if (this.battleBgm) {
      if (this.battleBgm.isPaused) this.battleBgm.resume();
      else if (!this.battleBgm.isPlaying) this.battleBgm.play();
    }
    if (this.attackTimer) this.attackTimer.paused = false;
    if (this.spawnTimer) this.spawnTimer.paused = false;
    this.scene.start("StartScene");
  }
  showPauseOverlay() {
    this.clearPauseOverlay();
    const bg = this.add.rectangle(GAME_WIDTH/2, GAME_HEIGHT/2, GAME_WIDTH, GAME_HEIGHT, 0x000000, 0.6)
      .setScrollFactor(0).setDepth(45);
    const title = this.add.text(GAME_WIDTH/2, GAME_HEIGHT/2 - 24, "游戏暂停", {
      fontFamily: '"Zpix", monospace', fontSize: "18px", color: "#ffffff",
    }).setOrigin(0.5).setScrollFactor(0).setDepth(46);
    ensureBaseFontSize(title);
    const prompt = this.add.text(GAME_WIDTH/2, GAME_HEIGHT/2 + 14, "按 ESC 或 Y 继续游戏，按 N 返回标题", {
      fontFamily: '"Zpix", monospace', fontSize: "14px", color: "#d0d0ff",
    }).setOrigin(0.5).setScrollFactor(0).setDepth(46);
    ensureBaseFontSize(prompt);

    this.pauseOverlayBackground = bg;
    this.pauseOverlayElements = [title, prompt];
    this.updateOverlayScale();

    this.pauseDecisionHandler = (e) => {
      if (!e) return;
      if (e.code === "KeyY" || e.code === "Enter" || e.code === "Escape") this.resumeGame();
      else if (e.code === "KeyN") this.exitToStartFromPause();
    };
    this.input.keyboard.on("keydown", this.pauseDecisionHandler, this);
  }
  clearPauseOverlay() {
    if (this.pauseOverlayElements?.length) this.pauseOverlayElements.forEach((el)=> el.destroy());
    this.pauseOverlayElements = [];
    if (this.pauseOverlayBackground) { this.pauseOverlayBackground.destroy(); this.pauseOverlayBackground = null; }
    if (this.pauseDecisionHandler) { this.input.keyboard.off("keydown", this.pauseDecisionHandler, this); this.pauseDecisionHandler = null; }
  }

  /* ==== 输入 ==== */
  setupInput() {
    this.keys = this.input.keyboard.addKeys({
      up: Phaser.Input.Keyboard.KeyCodes.W,
      down: Phaser.Input.Keyboard.KeyCodes.S,
